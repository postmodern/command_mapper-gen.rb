#!/usr/bin/env ruby

lib_dir = File.expand_path('../lib',__dir__)
$LOAD_PATH.unshift(lib_dir) unless $LOAD_PATH.include?(lib_dir)

require 'command_mapper/gen/parsers'
require 'command_mapper/gen/command'

USAGE = "usage: command_mapper-gen COMMAND_NAME [OUTPUT]"
BUG_REPORT_URL = "https://github.com/postmodern/command_mapper-gen/issues"

unless ARGV[0]
  $stderr.puts USAGE
  exit -1
end

if ARGV[0] == '--help' || ARGV[0] == '-h'
  puts USAGE
  exit
end

command = CommandMapper::Gen::Command.new(ARGV[0])
output  = ARGV[1]

parsers = [
  CommandMapper::Gen::Parsers::Help,
  CommandMapper::Gen::Parsers::Man
]

parsers.each do |parser|
  begin
    parser.run(command)
  rescue => error
    $stderr.puts "Oops! Looks like you've found a bug!"
    $stderr.puts "Please report the following to: #{BUG_REPORT_URL}"
    $stderr.puts
    $stderr.puts "```"
    $stderr.puts "#{error.full_message}"
    $stderr.puts "```"
    exit -1
  end
end

if output then command.save(output)
else           puts command.to_ruby
end
